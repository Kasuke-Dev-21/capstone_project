{% extends "_debug/test-web.html" %}

{% load static %}

{% block title %}
Search Reports
{% endblock %}

{% block head %}
    <style>
        #statusModal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        /* Style for debug panel */
        #debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f0f0f0;
            padding: 10px;
            box-sizing: border-box;
            overflow-y: auto; /* Enable scrolling if content exceeds height */
            max-height: 200px; /* Limit the height to prevent it from covering the scanner */
            display: none; /* Hide by default */
        }

        #debug-toggle {
            position: fixed;
            bottom: 210px; /* Position below the debug panel */
            left: 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            z-index: 9999; /* Ensure it's above other elements */
        }
    </style>

Request Status Change
{% endblock %}

{% block navlinks %}
    {% if user.is_authenticated %}
        <form action="{% url 'logout' %}" method="post" id="logout-form">
            {% csrf_token %}
            <button type="submit" class="login-button">Logout</button>
        </form>
    {% else %}
        <a href="{% url 'login' %}" class="login-button">Login</a>
    {% endif %}
{% endblock %}

{% block content %}

<div class="container">
    <div style="display: flex; justify-content: center;">
        <div style="position: relative; top: 30px; width: 500px" id="my-qr-reader"></div>
    </div>
</div>

<div id="statusModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <input type="hidden" id="studentIdInput" name="student_id">
      <button type="submit">Update Status</button>
    </form>
  </div>
</div>

<button id="debug-toggle">Toggle Debug</button>

<!-- Debug panel to print matching process -->
<div id="debug-panel">
    <pre id="debug-output"></pre>
</div>


<script src="{% static '/scripts/html5-qrcode.min.js' %}"></script>
<script>
// Function to find a match between decodeText and num_id
function matchNumId(decodeText) {
    // Get the list of student IDs from your Django template or server-side
    var studentIds = [
        {% for student in students %}
        "{{ student.num_id }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Debug output element
    var debugOutput = document.getElementById("debug-output");

    // Clear previous output
    debugOutput.textContent = "";

    // Print scanning process to debug output
    debugOutput.textContent += "Scanning QR code...\n";

    // Promisify the matching process
    return new Promise((resolve, reject) => {
        // Delay the matching process to simulate scanning
        setTimeout(() => {
            // Print scanned QR code to debug output
            debugOutput.textContent += "Scanned QR code: " + decodeText + "\n";

            // Check if the scanned QR code matches any student ID
            var matchedId = studentIds.find(id => id === decodeText);
            if (matchedId) {
                debugOutput.textContent += "Match found for student ID: " + matchedId + "\n";
                // Display the modal with the form to update status
                showModal(matchedId);
                resolve(matchedId); // Resolve with matched ID
            } else {
                debugOutput.textContent += "No matching student ID found for scanned QR code: " + decodeText + "\n";
                resolve(null); // Resolve with null if no match found
            }
        }, 2000); // 2000 milliseconds = 2 seconds delay
    });
}

// Function to display the modal with the form to update status
function showModal(studentId) {
    var modal = document.getElementById("statusModal");
    modal.style.display = "block";
    // Set the student ID value in the form
    document.getElementById("studentIdInput").value = studentId;
}

// Initialize QR scanner
document.addEventListener("DOMContentLoaded", function() {
    let htmlscanner = new Html5QrcodeScanner(
        "my-qr-reader",
        { fps: 10, qrbos: 250 }
    );
    htmlscanner.render(onScanSuccess);
});

// If found your QR code
function onScanSuccess(decodeText, decodeResult) {
    console.log("Scanned QR code:", decodeText);
    // Call your matching function here
    matchNumId(decodeText)
        .then(matchedId => {
            if (!matchedId) {
                console.log("No matching student ID found for QR code:", decodeText);
                alert("No matching student ID found.");
            }
        })
        .catch(error => {
            console.error("Error matching student ID:", error);
            alert("Error matching student ID.");
        });
}

// Close the modal when the user clicks on <span> (x)
document.getElementsByClassName("close")[0].onclick = function() {
    var modal = document.getElementById("statusModal");
    modal.style.display = "none";
}

// Close the modal when the user clicks anywhere outside of it
window.onclick = function(event) {
    var modal = document.getElementById("statusModal");
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
</script>


{% endblock %}